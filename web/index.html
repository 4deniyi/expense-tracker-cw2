<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Expense Tracker CW2</title>
</head>
<body>
  <h2>Expense Tracker CW2</h2>

  <div>
    <label>UserId:</label>
    <input id="userId" value="demoUser" />
  </div>

  <div>
    <label>Amount:</label>
    <input id="amount" type="number" />
  </div>

  <div>
    <label>Category:</label>
    <input id="category" />
  </div>

  <div>
    <label>Date:</label>
    <input id="date" type="date" />
  </div>

  <div>
    <label>Description:</label>
    <input id="description" />
  </div>

  <div>
    <label>Receipt image:</label>
    <input id="receipt" type="file" accept="image/*" />
  </div>

  <button onclick="createExpense()">Create Expense</button>
  <button onclick="loadExpenses()">Load Expenses</button>

  <pre id="out"></pre>

<script>
  // Put your working Function App domain here (no /api at the end)
  const API_BASE = "https://expensetracker-func-ade-bbfwadduhbhdbgdu.norwayeast-01.azurewebsites.net";

  // If your function requires a key, paste it here (from Get Function URL).
  // If your function is set to Anonymous, leave it as empty string.
  const FUNCTION_KEY = ""; // example: "AbCdEf123..."

  function log(x) {
    document.getElementById("out").textContent =
      typeof x === "string" ? x : JSON.stringify(x, null, 2);
  }

  function toBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => {
        const res = reader.result;
        const base64 = res.split(",")[1];
        resolve(base64);
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  function withKey(url) {
    if (!FUNCTION_KEY) return url;
    const sep = url.includes("?") ? "&" : "?";
    return url + sep + "code=" + encodeURIComponent(FUNCTION_KEY);
  }

  async function createExpense() {
    try {
      const userId = document.getElementById("userId").value;
      const amount = document.getElementById("amount").value;
      const category = document.getElementById("category").value;
      const date = document.getElementById("date").value;
      const description = document.getElementById("description").value;

      const file = document.getElementById("receipt").files[0];
      let receiptBase64 = null;
      let receiptContentType = null;

      if (file) {
        receiptBase64 = await toBase64(file);
        receiptContentType = file.type;
      }

      const payload = { userId, amount, category, date, description, receiptBase64, receiptContentType };

      const resp = await fetch(withKey(API_BASE + "/api/expenses"), {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const text = await resp.text();
      let data;
      try { data = JSON.parse(text); } catch { data = text; }

      log({ status: resp.status, data });
    } catch (e) {
      log(String(e));
    }
  }

  async function loadExpenses() {
    try {
      const userId = document.getElementById("userId").value;

      const url = withKey(API_BASE + "/api/expenses?userId=" + encodeURIComponent(userId));
      const resp = await fetch(url);

      const text = await resp.text();
      let data;
      try { data = JSON.parse(text); } catch { data = text; }

      log({ status: resp.status, data });
    } catch (e) {
      log(String(e));
    }
  }
</script>
</body>
</html>
